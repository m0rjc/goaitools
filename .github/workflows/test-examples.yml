name: Test Examples

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  test-examples:
    name: Run Examples with AI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'
          cache: true

      - name: Verify dependencies
        run: go mod download && go mod verify

      - name: Check for API key
        id: check-key
        run: |
          if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "has_key=true" >> $GITHUB_OUTPUT
          else
            echo "has_key=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è OPENAI_API_KEY not configured - skipping example tests"
          fi

      - name: Discover and run examples
        if: steps.check-key.outputs.has_key == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Find all example directories (those containing main.go)
          echo "üîç Discovering examples..."
          for example_dir in example/*/; do
            if [ -f "${example_dir}main.go" ]; then
              example_name=$(basename "$example_dir")
              echo ""
              echo "‚ñ∂Ô∏è  Running example: $example_name"
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

              cd "$example_dir"
              if go run . --model gpt-5-nano --request-params '{"max_completion_tokens":1500}'; then
                echo "‚úÖ $example_name completed successfully"
              else
                echo "‚ùå $example_name failed"
                exit 1
              fi
              cd - > /dev/null
            fi
          done

          echo ""
          echo "‚ú® All examples completed successfully"

      - name: Examples skipped
        if: steps.check-key.outputs.has_key == 'false'
        run: |
          echo "‚ÑπÔ∏è  Example tests were skipped because OPENAI_API_KEY is not configured."
          echo "   This is normal for pull requests from forks."
          echo "   To enable example tests, add OPENAI_API_KEY as a repository secret."
